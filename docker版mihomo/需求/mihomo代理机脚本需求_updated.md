# Mihomo 一键安装脚本需求 (更新版)

## 背景

Mihomo 一键安装脚本用于将普通的 Debian/Ubuntu 服务器转变为 mihomo 代理机，实现全自动部署和配置。本文档根据当前已实现的功能和优化需求进行更新，确保需求与功能保持一致。

## 系统与硬件要求

### 支持的系统
- Debian 10/11/12 或 Ubuntu 20.04/22.04/24.04 LTS
- 其他基于 Debian 的发行版可能兼容，但未经测试

## 脚本架构

整个解决方案由以下部分组成：

1. **主引导脚本（mihomo.sh）**：
   - 用户交互入口
   - 菜单系统和流程控制
   - 生成状态记录文件

2. **执行脚本**：
   - 代理机配置脚本（setup_proxy.sh）
   - RouterOS 配置脚本（setup_router.sh）

3. **状态跟踪和mihomo配置文件**：
   - 状态记录文件（mihomo_state.json）
   - 配置模板文件/原始配置文件（config.yaml）

## 主要功能与流程

### 1. 初始化设置
- 自动检测网络环境（主网卡、IP、网段等）
- 交互式设置 mihomo IP 地址（需用户确认）
- 运行代理机和路由器配置脚本

### 2. 配置代理机
- 自动安装 Docker 和必要依赖
- 设置网卡混杂模式和 macvlan 网络
- 创建 Docker 网络环境
- 下载和配置 mihomo UI 文件
- 部署 mihomo 容器
- 配置宿主机与容器通信

### 3. 配置路由器
- 生成 RouterOS 配置命令
- 提供多种路由器配置指南
- 支持 RouterOS、OpenWrt 和其他常见路由器

### 4. 配置管理功能
- 查看/编辑/重置配置文件
- 重启 mihomo 服务
- 检查安装状态和服务运行情况

### 5. 卸载功能
- 完整卸载 mihomo 和相关配置
- 配置文件自动备份

## 技术实现细节

### 状态记录文件规范

状态记录文件采用 JSON 格式，包含以下信息：
```json
{
  "mihomo_ip": "192.168.88.4",
  "interface_ip": "192.168.88.5",
  "main_interface": "ens18",
  "macvlan_interface": "mihomo_veth",
  "installation_stage": "初始化",
  "config_type": "",
  "subscription_url": "",
  "docker_method": "direct_pull",
  "timestamp": "2025-05-21 03:20:45"
}
```

### 网络配置逻辑

1. **IP 地址分配**：
   - 自动检测主网卡接口及其 IP 地址，确定所在局域网网段
   - 基于检测到的网段，向用户建议可用的 mihomo IP 地址
   - 为 macvlan 接口自动分配相邻的可用 IP
   - 使用 ping 测试确保分配的 IP 不与网络中的现有设备冲突

2. **Docker macvlan 网络配置**：
   - 开启主网络接口的混杂模式
   - 设置基于当前网段的 macvlan 网络
   - 创建持久化的网络配置，确保系统重启后网络设置依然有效

3. **宿主机和 Docker 通信配置**：
   - 创建 macvlan 接口桥接 Docker 和宿主机
   - 设置路由规则实现相互访问

### 配置文件管理策略

简化的配置文件管理策略：
1. **使用预设模板**：
   - 提供原版配置文件，用户自行修改代理节点部分
   - 无需区分不同类型的配置方式（如机场订阅、VPS 等）
   - 通过编辑器或 SFTP 等工具修改配置文件

2. **配置文件确认机制**：
   - 不要修改原始ymal配置文件，直接将其复制后给mihomo使用；
   - 验证 bind-address 设置为"*"以允许局域网访问
   - 提供重启 mihomo 服务以应用配置更改

### 错误处理机制

1. **网络检测错误处理**：
   - 无法获取网络接口或 IP 地址时提供明确错误信息
   - 在每个关键步骤添加错误检测和恢复流程

2. **Docker 安装与配置错误处理**：
   - 检测 Docker 安装失败并提供恢复方案
   - 镜像拉取失败时提供备选方案（本地镜像导入），需引导用户如何操作
   - 容器启动失败时提供日志分析和解决建议

3. **配置文件错误**：
   - 检测配置语法错误
   - 提供详细的配置问题解决指南

## 优化方向

### 已实现的优化
1. **整合引导界面**：
   - 主菜单整合所有功能，提供清晰的安装流程指导
   - 安装状态跟踪，允许从中断处继续安装

2. **代理机重新配置优化**：
   - 检测现有 mihomo 安装，提供重新安装选项
   - 保留原有配置文件，简化重新安装流程

3. **配置文件管理优化**：
   - 简化为单一配置流程，用户手动编辑配置文件
   - 提供配置文件编辑工具和重启服务功能

### 待实现/改进的优化

1. **配置文件语法检查**：
   - 增强配置文件语法检查功能
   - 提供更精确的配置错误修复建议

2. **安装错误处理改进**：
   - 改进镜像拉取失败的处理
   - 提供更完善的离线安装指导

3. **代码结构优化**：
   - 优化引导脚本中的重复代码
   - 改进错误处理和日志记录机制

4. **引导脚本语法优化**：
   - 修复潜在的语法错误
   - 确保所有生成的脚本都能顺利执行，无语法问题


## 使用指南

### 安装说明
1. 将脚本放置到合适位置（推荐 /opt 目录）
2. 确保脚本有执行权限
3. 以 root 权限运行脚本
4. 按照交互式引导完成配置

### 安装流程
1. **初始化设置**：设置 mihomo IP 地址
2. **配置代理机**：安装 Docker 和 mihomo
3. **配置路由器**：配置 RouterOS 或其他路由器指向 mihomo
4. **验证安装**：检查服务状态和连通性

### 配置文件修改指南
1. 使用 nano 或 vim 编辑器修改配置文件
2. 主要修改 proxies 部分添加代理节点
3. 修改后通过主菜单重启服务生效

## 重要注意事项

1. 确保网络环境稳定，特别是执行 Docker 镜像拉取时
2. 对于网络受限环境，提供离线安装方式和本地镜像导入功能
3. 配置文件中 external-controller 和 bind-address 设置对于局域网访问至关重要
4. 重启 mihomo 服务后，务必验证服务正常运行

## 语法和代码规范

1. 确保所有生成的脚本没有语法错误，特别是引号匹配和条件语句嵌套
2. 避免在脚本中使用硬编码的网络接口名称
3. 确保适当的错误处理和用户提示
4. 保持代码可读性和一致的缩进风格
5. 避免在生成的脚本中使用可能导致转义问题的特殊字符
